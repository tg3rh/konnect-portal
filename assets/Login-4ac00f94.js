import{a as D,u as H,e as A,s as K,f as M,_ as B}from"./index-c37d0faa.js";import{A as R}from"./AuthCard-9da09d94.js";import{d as x,a as E,c as I,af as $,o as N,f as r,i as f,j as y,x as j,k as S,l as w,n as T,t as b,v as C,u as v,q}from"./vue-62e5e94d.js";import{u as z,c as G}from"./useMachine-f5553fb5.js";import"./kongponents-0cdf713a.js";const J=x({name:"Login",components:{AuthCard:R},setup(){const e=E(""),{portalApiV2:u}=D(),d=H().state.helpText,k=A(),{developerSession:s,authClientConfig:p}=K(k),g=I(()=>p.value.basicAuthEnabled),{initialize:m}=M(),i=$(),c=E(""),h=()=>{i.push({path:"/forgot-password"})},U=(t={})=>{const{email:n,resetToken:o}=t;i.push({path:"/reset-password",query:{email:n,token:o}})},{state:L,send:_}=z(G({id:"loginMachine",predictableActionArguments:!0,initial:"idle",states:{idle:{on:{KAUTH_SUCCESS:"user_fetch"}},success_login:{type:"final"},user_fetch:{on:{USER_FETCH_SUCCESS:"success_login",USER_FETCH_FAIL:"error"}},error:{on:{KAUTH_SUCCESS:"user_fetch"}}}})),F=(t,n)=>{var a;const o=t.message&&t.message[0]&&((a=t.message[0])==null?void 0:a.constraints)||t.message||n.message;return Array.isArray(o)?o.join(". "):o},P=async()=>{_("KAUTH_SUCCESS");let t,n;try{[t,n]=await Promise.all([u.value.service.developerApi.getDeveloperMe(),u.value.service.portalApi.getPortalContext()])}catch(l){_("USER_FETCH_FAIL");const{data:V}=l.response;if(l.response.status===401){e.value=d.login.unauthenticated;return}e.value=F(V,l)}_("USER_FETCH_SUCCESS");const{setPortalData:o}=A();o({featureSet:n.data.feature_set}),s.value.saveData({...s.value.data,developer:t.data});let a="/";s.value.data.to&&(a=s.value.data.to);try{await m()}catch{console.error("Unable to update LD context")}window.location.href=a};return N(()=>{c.value=window.location.origin+"/login"}),{isBasicAuthEnabled:g,currentState:L,errorMessage:e,onUserClickForgotPassword:h,onLoginSuccess:P,onVerifyEmailSuccess:U,session:s,authClientConfig:p,redirectTo:c,helpText:d}}});const O={key:1,id:"kong-auth-login-wrapper"},Q={id:"sign-up-encouragement-message","data-testid":"sign-up-encouragement-message",class:"mt-6 text-center"},W={class:"color-text_colors-primary"};function X(e,u,d,k,s,p){const g=r("KAlert"),m=r("kong-auth-login"),i=r("KIcon"),c=r("router-link"),h=r("AuthCard");return["success_login","user_fetch"].includes(e.currentState.value)?v("",!0):(f(),y(h,{key:0},j({default:S(()=>[e.currentState.matches("error")?(f(),y(g,{key:0,"alert-message":e.errorMessage,appearance:"danger",class:"justify-content-center my-3","data-testid":"unauthenticated-message"},null,8,["alert-message"])):v("",!0),["idle","error"].includes(e.currentState.value)&&e.redirectTo?(f(),q("div",O,[C(m,{"wrapper-id":"kong-auth-login-wrapper","show-forgot-password-link":"","register-success-text":e.helpText.registration.successText,"idp-login-return-to":e.redirectTo,"basic-auth-login-enabled":e.authClientConfig.basicAuthEnabled,"idp-login-enabled":e.authClientConfig.oidcAuthEnabled,onLoginSuccess:e.onLoginSuccess,onClickForgotPasswordLink:e.onUserClickForgotPassword,onVerifyEmailSuccess:e.onVerifyEmailSuccess},null,8,["register-success-text","idp-login-return-to","basic-auth-login-enabled","idp-login-enabled","onLoginSuccess","onClickForgotPasswordLink","onVerifyEmailSuccess"])])):v("",!0)]),_:2},[e.isBasicAuthEnabled&&["idle","error"].includes(e.currentState.value)?{name:"below-card",fn:S(()=>[w("span",Q,[w("p",W,[T(b(e.helpText.login.missingAccount)+" ",1),C(c,{to:{name:"registration"}},{default:S(()=>[T(b(e.helpText.login.signUp)+" ",1),C(i,{color:"var(--text_colors-link)",icon:"forward"})]),_:1})])])]),key:"0"}:void 0]),1024))}const se=B(J,[["render",X]]);export{se as default};
